import { useEffect, useState } from 'react'
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet'
import 'leaflet/dist/leaflet.css'
import L from 'leaflet'
import { db } from '../features/offline/db'
import { Link } from 'react-router-dom'

export default function AllJobsMap() {
  const [jobs, setJobs] = useState<any[]>([])

  // Ensure marker icons load
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  (L.Icon.Default as any).mergeOptions?.({
    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  })

  useEffect(() => { (async () => setJobs(await db.jobs.toArray()))() }, [])

  const center: [number, number] = jobs.find(j => typeof j.lat === 'number' && typeof j.lon === 'number')
    ? [jobs[0].lat, jobs[0].lon]
    : [30.2672, -97.7431]

  return (
    <div className="grid">
      <section className="card">
        <h2>All Sites</h2>
        <div style={{ height: 540 }}>
          <MapContainer center={center} zoom={7} style={{ height: '100%', width: '100%' }}>
            <TileLayer
              attribution='Tiles &copy; Esri â€” Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
              url='https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            />
            {jobs.filter(j => typeof j.lat === 'number' && typeof j.lon === 'number').map((j) => (
              <Marker key={j.id} position={[j.lat, j.lon] as any}>
                <Popup>
                  <div style={{ display: 'grid', gap: 6 }}>
                    <div><strong>{j.clientName}</strong>{j.siteName ? ' - ' + j.siteName : ''}</div>
                    <Link className="btn" to={`/job/${j.id}`}>Open Job</Link>
                  </div>
                </Popup>
              </Marker>
            ))}
          </MapContainer>
        </div>
      </section>
    </div>
  )
}


